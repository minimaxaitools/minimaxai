<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Automator v3 (Stable)</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gray: {
                            750: '#2d3748',
                            850: '#1a202c',
                            950: '#0d1117',
                        },
                        accent: {
                            500: '#3b82f6',
                            600: '#2563eb',
                        }
                    },
                    fontFamily: {
                        mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', "Liberation Mono", "Courier New", 'monospace'],
                    }
                }
            }
        }
    </script>

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- SortableJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1a202c; }
        ::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #718096; }

        .variable-card.sortable-ghost { opacity: 0.4; background: #2d3748; border: 1px dashed #4a5568; }
        .history-card { transition: all 0.2s ease; }
        .history-card:hover { transform: translateY(-1px); border-color: #4a5568; }
    </style>
</head>
<body class="bg-gray-950 text-gray-100 h-screen flex flex-col overflow-hidden font-sans selection:bg-accent-500 selection:text-white">

<!-- Navbar -->
<header class="h-14 bg-gray-900 border-b border-gray-800 flex items-center justify-between px-6 shrink-0 z-20">
    <div class="flex items-center gap-3">
        <i class="fa-solid fa-layer-group text-accent-500 text-xl"></i>
        <h1 class="font-bold text-lg tracking-wide text-gray-100">PGWOR<span class="text-accent-500">Flow</span> <span class="text-xs text-gray-500 font-normal ml-2">v3.0</span></h1>
    </div>
    <div class="flex items-center gap-3">
        <button onclick="window.app.exportData()" class="text-xs font-medium bg-gray-800 hover:bg-gray-700 text-gray-300 py-1.5 px-3 rounded transition flex items-center gap-2 border border-gray-700">
            <i class="fa-solid fa-download"></i> Export DB
        </button>
        <label class="text-xs font-medium bg-gray-800 hover:bg-gray-700 text-gray-300 py-1.5 px-3 rounded transition flex items-center gap-2 cursor-pointer border border-gray-700">
            <i class="fa-solid fa-upload"></i> Import DB
            <input type="file" id="importFile" class="hidden" onchange="window.app.importData(this)">
        </label>
    </div>
</header>

<!-- Main Layout -->
<main class="flex-1 flex overflow-hidden">

    <!-- LEFT PANEL: Variables -->
    <aside class="w-80 bg-gray-900 border-r border-gray-800 flex flex-col z-10 shadow-xl flex-shrink-0">
        <div class="p-4 border-b border-gray-800 bg-gray-900 sticky top-0">
            <h2 class="text-sm font-semibold uppercase tracking-wider text-gray-400 flex justify-between items-center">
                <span>Variables</span>
                <span id="varCount" class="bg-gray-800 text-accent-500 text-xs py-0.5 px-2 rounded-full border border-gray-700">0</span>
            </h2>
            <p class="text-xs text-gray-500 mt-2">Detected from <code>[brackets]</code>. Drag to reorder.</p>
        </div>

        <div id="variablesList" class="flex-1 overflow-y-auto p-4 space-y-3">
            <!-- Variables injected here -->
        </div>

        <div class="p-4 border-t border-gray-800 bg-gray-900">
            <button onclick="window.app.clearVariables()" class="w-full py-2 text-xs font-semibold text-gray-400 hover:text-white hover:bg-gray-800 border border-transparent hover:border-gray-700 rounded transition uppercase tracking-wide">
                <i class="fa-solid fa-eraser mr-2"></i>Reset Values
            </button>
        </div>
    </aside>

    <!-- CENTER PANEL: Workspace -->
    <section class="flex-1 flex flex-col min-w-0 bg-gray-950 relative">

        <!-- Split View -->
        <div class="flex-1 flex flex-col h-full">

            <!-- Template Editor (Top Half) -->
            <div class="h-1/2 flex flex-col border-b border-gray-800">
                <div class="h-10 bg-gray-900 border-b border-gray-800 flex items-center justify-between px-4 shrink-0">
                    <span class="text-xs font-bold text-gray-400 uppercase"><i class="fa-solid fa-code mr-2"></i>Template Editor</span>
                    <div class="flex gap-2">
                        <button onclick="window.app.pasteFromClipboard()" class="text-xs bg-gray-800 hover:bg-gray-700 text-gray-200 px-3 py-1 rounded border border-gray-700 transition">
                            <i class="fa-solid fa-paste mr-1"></i> Paste
                        </button>
                        <button onclick="window.app.loadDefaultTemplate()" class="text-xs text-accent-500 hover:text-accent-400 font-medium px-2 py-1 bg-accent-500/10 rounded border border-accent-500/20">Load Default</button>
                    </div>
                </div>
                <textarea id="templateInput"
                          class="flex-1 bg-gray-950 text-gray-300 p-6 focus:outline-none resize-none font-mono text-sm leading-relaxed"
                          placeholder="Type your PGWOR here using [variable] placeholders..."
                          spellcheck="false"></textarea>
            </div>

            <!-- Live Preview (Bottom Half) -->
            <div class="h-1/2 flex flex-col bg-gray-900/50">
                <div class="h-10 bg-gray-900 border-b border-gray-800 flex items-center justify-between px-4 shrink-0">
                    <span class="text-xs font-bold text-accent-500 uppercase"><i class="fa-solid fa-wand-magic-sparkles mr-2"></i>Result Preview</span>
                    <div class="flex gap-2">
                        <button onclick="window.app.copyPreview()" class="text-xs bg-accent-600 hover:bg-accent-500 text-white px-3 py-1 rounded shadow transition">
                            <i class="fa-regular fa-copy mr-1"></i> Copy Result
                        </button>
                    </div>
                </div>
                <div class="flex-1 relative group overflow-hidden">
                        <textarea id="previewOutput" readonly
                                  class="w-full h-full bg-gray-900/30 text-gray-100 p-6 focus:outline-none resize-none font-mono text-sm leading-relaxed"
                                  placeholder="Your compiled PGWOR will appear here..."></textarea>

                    <!-- Floating Save Button -->
                    <div class="absolute bottom-6 right-6 z-20">
                        <button onclick="window.app.saveCurrentPGWOR()" title="Save to History" class="bg-accent-600 hover:bg-accent-500 text-white shadow-lg shadow-accent-600/30 rounded-full h-14 w-14 flex items-center justify-center transition transform hover:scale-105 active:scale-95 group-hover:flex">
                            <i class="fa-solid fa-floppy-disk text-xl"></i>
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </section>

    <!-- RIGHT PANEL: History -->
    <aside class="w-96 bg-gray-900 border-l border-gray-800 flex flex-col z-10 shadow-xl flex-shrink-0">
        <!-- Tabs -->
        <div class="flex border-b border-gray-800 bg-gray-900">
            <button onclick="window.app.switchTab('all')" id="tab-all" class="flex-1 py-3 text-sm font-medium text-accent-500 border-b-2 border-accent-500 bg-gray-800/50 transition">
                History
            </button>
            <button onclick="window.app.switchTab('fav')" id="tab-fav" class="flex-1 py-3 text-sm font-medium text-gray-500 hover:text-gray-300 border-b-2 border-transparent transition">
                Favorites
            </button>
        </div>

        <!-- Search -->
        <div class="p-3 border-b border-gray-800 bg-gray-900">
            <div class="relative">
                <i class="fa-solid fa-magnifying-glass absolute left-3 top-2.5 text-gray-500 text-xs"></i>
                <input type="text" id="searchInput" oninput="window.app.filterHistory()"
                       class="w-full bg-gray-800 text-gray-200 text-xs rounded pl-8 pr-3 py-2 border border-gray-700 focus:border-accent-500 focus:outline-none transition"
                       placeholder="Search stored PGWORs...">
            </div>
        </div>

        <!-- List -->
        <div id="historyList" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-900">
            <!-- Items injected here -->
        </div>

        <!-- Footer -->
        <div class="p-3 border-t border-gray-800 bg-gray-900 text-center">
            <button onclick="window.app.clearHistory()" class="text-xs text-red-400 hover:text-red-300 hover:bg-red-900/20 py-2 px-4 rounded transition w-full border border-transparent hover:border-red-900/50">
                <i class="fa-solid fa-dumpster-fire mr-1"></i> Flush Entire Database
            </button>
        </div>
    </aside>

</main>

<!-- Notification Toast -->
<div id="toast" class="fixed bottom-5 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-5 py-3 rounded-lg shadow-xl border border-gray-700 flex items-center gap-3 translate-y-20 opacity-0 transition-all duration-300 z-50 pointer-events-none">
    <i class="fa-solid fa-check-circle text-green-400 text-lg"></i>
    <span id="toastMsg" class="text-sm font-medium">Notification</span>
</div>

<!-- DB Logic & App Logic -->
<script>

    // --- IndexedDB Wrapper ---
    class PGWORDB {
        constructor(dbName = 'DB_v3', storeName = 'PGWORDs') {
            this.dbName = dbName;
            this.storeName = storeName;
            this.db = null;
        }

        async open() {
            return new Promise((resolve, reject) => {
                // FIX APPLIED HERE:
                // Changed version to 3 to force 'onupgradeneeded' to fire again
                const request = indexedDB.open(this.dbName, 3);

                request.onupgradeneeded = (e) => {
                    this.db = e.target.result;
                    // This code now runs because version 3 > version 2
                    if (!this.db.objectStoreNames.contains(this.storeName)) {
                        const store = this.db.createObjectStore(this.storeName, { keyPath: 'id' });
                        store.createIndex('timestamp', 'timestamp', { unique: false });
                        console.log("Object Store created successfully");
                    }
                };
                request.onsuccess = (e) => {
                    this.db = e.target.result;
                    resolve(this.db);
                };
                request.onerror = (e) => reject("DB Open Error: " + e.target.error);
            });
        }

        async add(item) {
            return this.transaction('readwrite', store => store.put(item));
        }

        async getAll() {
            return new Promise((resolve, reject) => {
                if (!this.db) return reject("DB Closed");

                // Safety Check: If store is missing, return empty array instead of crashing
                if (!this.db.objectStoreNames.contains(this.storeName)) {
                    console.warn("Store not found, returning empty list.");
                    return resolve([]);
                }

                try {
                    const tx = this.db.transaction(this.storeName, 'readonly');
                    const store = tx.objectStore(this.storeName);
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                } catch (err) {
                    reject(err);
                }
            });
        }

        async delete(id) {
            return new Promise((resolve, reject) => {
                if (!this.db) return reject("DB Closed");
                const tx = this.db.transaction(this.storeName, 'readwrite');
                const store = tx.objectStore(this.storeName);
                const request = store.delete(id);
                tx.oncomplete = () => resolve(true);
                tx.onerror = () => reject(tx.error);
            });
        }

        async clear() {
            return new Promise((resolve, reject) => {
                if (!this.db) return reject("DB Closed");
                const tx = this.db.transaction(this.storeName, 'readwrite');
                const store = tx.objectStore(this.storeName);
                store.clear();
                tx.oncomplete = () => resolve(true);
                tx.onerror = () => reject(tx.error);
            });
        }

        transaction(type, callback) {
            return new Promise((resolve, reject) => {
                if (!this.db) return reject("DB not init");
                try {
                    const tx = this.db.transaction(this.storeName, type);
                    const store = tx.objectStore(this.storeName);
                    const request = callback(store);
                    tx.oncomplete = () => resolve(request ? request.result : 'ok');
                    tx.onerror = () => reject(tx.error);
                } catch (err) {
                    reject(err);
                }
            });
        }
    }

    // --- Main App Logic ---
    class App {
        constructor() {
            this.db = new PGWORDB();
            this.currentVariables = {};
            this.currentTab = 'all';
            this.historyCache = []; // Local cache for filtering

            // Elements
            this.templateInput = document.getElementById('templateInput');
            this.previewOutput = document.getElementById('previewOutput');
            this.variablesList = document.getElementById('variablesList');
            this.historyList = document.getElementById('historyList');
            this.searchInput = document.getElementById('searchInput');
            this.varCountDisplay = document.getElementById('varCount');
        }

        async init() {
            try {
                await this.db.open();
            } catch(e) { console.error(e); }

            this.initSortable();

            // Load autosave or default
            const savedTemplate = localStorage.getItem('autosave_template');
            const savedVars = localStorage.getItem('autosave_vars');

            if (savedTemplate) {
                this.templateInput.value = savedTemplate;
                if(savedVars) {
                    try { this.currentVariables = JSON.parse(savedVars); } catch(e) {}
                }
            } else {
                this.loadDefaultTemplate(true); // Force load silently
            }

            // Listeners
            this.templateInput.addEventListener('input', () => {
                this.renderVariablesPanel();
                this.updatePreview();
                this.autoSave();
            });

            // Initial Render
            this.renderVariablesPanel();
            this.updatePreview();
            this.refreshHistory();
        }

        initSortable() {
            new Sortable(this.variablesList, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                handle: '.drag-handle',
            });
        }

        autoSave() {
            localStorage.setItem('autosave_template', this.templateInput.value);
            localStorage.setItem('autosave_vars', JSON.stringify(this.currentVariables));
        }

        // --- Clipboard Logic ---
        async pasteFromClipboard() {
            try {
                const text = await navigator.clipboard.readText();
                const input = this.templateInput;
                const start = input.selectionStart;
                const end = input.selectionEnd;
                const val = input.value;
                input.value = val.substring(0, start) + text + val.substring(end);
                input.selectionStart = input.selectionEnd = start + text.length;
                input.focus();

                // Trigger updates
                this.renderVariablesPanel();
                this.updatePreview();
                this.autoSave();
                this.showToast("Pasted successfully");
            } catch (err) {
                // Fallback if browser blocks API
                this.showToast("Clipboard blocked. Please use Ctrl+V", true);
                this.templateInput.focus();
            }
        }

        // --- Template Logic ---
        loadDefaultTemplate(silent = false) {
            if(!silent && this.templateInput.value.trim() !== "" && !confirm("Replace current workspace with the default template?")) {
                return;
            }

            const defaultText = `For any uploaded image (subject, object, scene, living, non-living), generate a [style] reinterpretation that respects its dominant colors and inherent mood, while allowing for [style] transformation.

Create:
"A [style] version of the exact subject(s), object(s), scene, or elements from the uploaded image, rendered in a hybrid style that fuses photographic realism with [style] characteristics."

All original features, compositions, dominant colors, textures, proportions, and details must remain 100% identical to the reference image, but may be playfully exaggerated or enhanced according to [style] as follows:

* **[STYLE] Transformation:** The primary subject(s), object(s), or key elements receive expressive [style] features, actions, or emotional qualities that either complement or amplify the original mood.

  * **For living subjects (people, animals):** Apply [style] expressive enhancements such as modified eyes, gestures, facial expressions, or body language.

  * **For non-living objects or shapes:** Apply [style] reinterpretation, including form exaggeration, texture adjustments, symbolic expressions, or anthropomorphic hints.

  * **For full scenes or backgrounds:** Integrate [style] narrative qualities, thematic expressions, or atmospheric enhancements without altering the core layout.

  * **Artistic Fusion:** All [style] features blend smoothly with the photorealistic base, appearing naturally integrated into the scene.

* **Optional Linework Layer:** If relevant to [style], apply lines, strokes, marks, or outlines that match the visual language of the chosen style.

* **Optional Texture/Surface Layer:** If [style] includes watercolor, oil, ink, sketch, doodle, anime, comic, or other textures, apply them minimally or fully depending on the desired intensity.

* **Background:** Use a solid or gradient background based on [style], ensuring it complements the image’s dominant colors and maintains a clean, studio-like presentation.

* **Lighting:** Use soft, even lighting unless [style] explicitly requires dramatic, directional, cinematic, neon, rim-lit, or stylized light.

* **Mood:** Reflect or enhance the image’s inherent mood through [style] interpretation (serene, energetic, whimsical, dramatic, humorous, contemplative, etc.).

* **Keywords:** hybrid realism + [style], expressive reinterpretation, color harmony, mood-aligned, detail-preserving, [style] enhancement.

* **Aspect Ratio:** Use 1:1 or 9:16 based on the closest matching dimension of the uploaded image.

HOW TO USE THIS UNIVERSAL PGWOR:

1. **Analyze the Image:** Identify primary subjects, objects, and visual focus areas.

2. **Determine [Style] Transformation:** Describe how [style] modifies shapes, expressions, atmosphere, or textures.

   *Person example:* “[style] exaggerates the smile, brightens the eyes, and adds expressive motion.”

   *Object example:* “[style] adds symbolic curves and expressive highlights.”

   *Cityscape example:* “[style] applies atmospheric mood and stylized window expressions.”

   *Landscape example:* “[style] softens contours and adds emotional ambiance.”

3. **Select Background:** Use a pastel, vivid, dark, or thematic color depending on [style].

4. **Define Mood:** Decide whether [style] mirrors, enhances, or transforms the original emotion.

5. **Generate the Image:** Use these universal instructions with your chosen [style].`;

            this.templateInput.value = defaultText;
            this.currentVariables = {
                "style": "cartoon watercolor hybrid"
            };
            this.renderVariablesPanel();
            this.updatePreview();
            this.autoSave();
            if(!silent) this.showToast("Default template loaded");
        }

        // --- Variable Parsing (Case Insensitive normalization) ---
        getUniqueVariables(text) {
            const regex = /\[(.*?)\]/g;
            const found = new Set();
            let match;
            while ((match = regex.exec(text)) !== null) {
                // Lowercase for the KEY, so [STYLE] and [style] share one input
                found.add(match[1].trim().toLowerCase());
            }
            return Array.from(found);
        }

        renderVariablesPanel() {
            const text = this.templateInput.value;
            const variables = this.getUniqueVariables(text);

            this.varCountDisplay.textContent = variables.length;

            if (variables.length === 0) {
                this.variablesList.innerHTML = `<div class="text-center text-gray-600 mt-10 text-sm">No variables detected.<br>Add <code>[variable]</code> to your template.</div>`;
                return;
            }

            this.variablesList.innerHTML = '';

            variables.forEach(v => {
                const wrapper = document.createElement('div');
                wrapper.className = 'variable-card bg-gray-800 border border-gray-700 rounded-lg p-3 group transition hover:border-gray-600';

                const header = document.createElement('div');
                header.className = 'flex items-center justify-between mb-2';

                const labelDiv = document.createElement('div');
                labelDiv.className = 'flex items-center gap-2 overflow-hidden';

                const dragHandle = document.createElement('i');
                dragHandle.className = 'fa-solid fa-grip-vertical text-gray-600 hover:text-gray-400 cursor-move drag-handle py-1 pr-2';

                const label = document.createElement('label');
                label.className = 'text-xs font-bold text-accent-500 uppercase tracking-wider truncate cursor-pointer';
                label.textContent = v;
                label.onclick = () => { navigator.clipboard.writeText(`[${v}]`); this.showToast(`Copied [${v}]`); };

                labelDiv.appendChild(dragHandle);
                labelDiv.appendChild(label);

                // Clear button
                const clearBtn = document.createElement('button');
                clearBtn.innerHTML = '<i class="fa-solid fa-rotate-left"></i>';
                clearBtn.className = 'text-gray-600 hover:text-white text-xs opacity-0 group-hover:opacity-100 transition px-2';
                clearBtn.onclick = () => { input.value = ''; this.updateVariable(v, ''); };

                header.appendChild(labelDiv);
                header.appendChild(clearBtn);

                const input = document.createElement('textarea');
                input.rows = 1;
                input.className = 'w-full bg-gray-900 border border-gray-700 rounded px-2 py-2 text-sm text-gray-200 focus:border-accent-500 focus:ring-1 focus:ring-accent-500 focus:outline-none resize-none overflow-hidden';
                input.placeholder = `Value for [${v}]`;
                input.value = this.currentVariables[v] || '';

                input.addEventListener('input', (e) => {
                    this.updateVariable(v, e.target.value);
                    e.target.style.height = 'auto';
                    e.target.style.height = e.target.scrollHeight + 'px';
                });

                wrapper.appendChild(header);
                wrapper.appendChild(input);
                this.variablesList.appendChild(wrapper);
            });
        }

        updateVariable(key, value) {
            this.currentVariables[key] = value;
            this.autoSave();
            this.updatePreview();
        }

        clearVariables() {
            this.currentVariables = {};
            this.renderVariablesPanel();
            this.updatePreview();
            this.showToast('Variables reset');
        }

        updatePreview() {
            let text = this.templateInput.value;
            const vars = this.currentVariables;

            // Replace using Case Insensitive Regex logic
            // Iterate through known variables keys
            Object.keys(vars).forEach(key => {
                if (vars[key]) {
                    // Regex matches [Key] or [KEY] or [key]
                    const regex = new RegExp(`\\[${key}\\]`, 'gi');
                    text = text.replace(regex, vars[key]);
                }
            });
            this.previewOutput.value = text;
        }

        copyPreview() {
            if(!this.previewOutput.value) return;
            this.previewOutput.select();
            document.execCommand('copy');
            window.getSelection().removeAllRanges();
            this.showToast("Result copied!");
        }

        // --- History Actions ---

        async saveCurrentPGWOR() {
            const template = this.templateInput.value;
            if (!template.trim()) {
                this.showToast("Template is empty!", true);
                return;
            }

            const item = {
                id: crypto.randomUUID(),
                timestamp: Date.now(),
                template: template,
                variables: {...this.currentVariables},
                isFavorite: false
            };

            await this.db.add(item);
            this.refreshHistory();
            this.showToast("Saved to History");
        }

        async refreshHistory() {
            try {
                this.historyCache = await this.db.getAll();
                this.historyCache.sort((a, b) => b.timestamp - a.timestamp); // Newest first
                this.renderHistoryList();
            } catch(e) {
                console.error("History Error", e);
            }
        }

        renderHistoryList() {
            const list = this.historyList;
            const search = this.searchInput.value.toLowerCase();

            let items = this.historyCache.filter(i => {
                const inTemplate = i.template.toLowerCase().includes(search);
                const inVars = Object.values(i.variables).some(v => v.toLowerCase().includes(search));
                const isFav = this.currentTab === 'fav' ? i.isFavorite : true;
                return (inTemplate || inVars) && isFav;
            });

            list.innerHTML = '';

            if(items.length === 0) {
                list.innerHTML = `<div class="text-center text-gray-600 mt-10"><i class="fa-regular fa-folder-open text-3xl mb-2"></i><p class="text-xs">No matching PGWORs.</p></div>`;
                return;
            }

            items.forEach(item => {
                const card = document.createElement('div');
                card.className = 'history-card bg-gray-800 border border-gray-700 rounded-lg p-3 relative group mb-3';

                // Title logic
                let title = 'Untitled';
                if (item.variables['style']) title = item.variables['style'];
                else if (Object.values(item.variables)[0]) title = Object.values(item.variables)[0];
                if (title.length > 30) title = title.substring(0,30) + '...';

                const dateStr = new Date(item.timestamp).toLocaleDateString();

                card.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-bold text-gray-200 text-sm truncate pr-2 w-full cursor-pointer" onclick="window.app.loadItem('${item.id}')">${title}</h3>
                            <button onclick="window.app.toggleFavorite('${item.id}')" class="text-gray-500 hover:text-yellow-400 transition flex-shrink-0 ml-2">
                                <i class="${item.isFavorite ? 'fa-solid text-yellow-400' : 'fa-regular'} fa-star"></i>
                            </button>
                        </div>
                        <p class="text-xs text-gray-400 font-mono mb-3 leading-relaxed opacity-80 h-10 overflow-hidden">${item.template.substring(0, 100)}...</p>

                        <div class="flex items-center justify-between mt-2 pt-2 border-t border-gray-700/50">
                            <span class="text-[10px] text-gray-600">${dateStr}</span>
                            <div class="flex gap-2">
                                <button onclick="window.app.loadItem('${item.id}')" title="Load" class="text-accent-500 hover:text-white bg-gray-900 hover:bg-accent-600 p-1.5 rounded transition">
                                    <i class="fa-solid fa-upload"></i>
                                </button>
                                <button onclick="window.app.copyItemText('${item.id}')" title="Copy Result" class="text-gray-400 hover:text-white bg-gray-900 hover:bg-gray-700 p-1.5 rounded transition">
                                    <i class="fa-regular fa-copy"></i>
                                </button>
                                <button onclick="window.app.deleteItem('${item.id}')" title="Delete" class="text-gray-400 hover:text-red-400 bg-gray-900 hover:bg-red-900/30 p-1.5 rounded transition">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                list.appendChild(card);
            });
        }

        async loadItem(id) {
            const item = this.historyCache.find(i => i.id === id);
            if (item) {
                this.templateInput.value = item.template;
                this.currentVariables = {...item.variables};
                this.renderVariablesPanel();
                this.updatePreview();
                this.autoSave();
                this.showToast("PGWOR loaded");
                // Scroll up
                this.templateInput.scrollIntoView({behavior: "smooth"});
            }
        }

        async toggleFavorite(id) {
            const item = this.historyCache.find(i => i.id === id);
            if (item) {
                item.isFavorite = !item.isFavorite;
                await this.db.add(item);
                this.refreshHistory();
            }
        }

        async deleteItem(id) {
            if(!confirm("Are you sure you want to delete this PGWOR?")) return;
            await this.db.delete(id);
            this.refreshHistory();
            this.showToast("Item deleted");
        }

        async copyItemText(id) {
            const item = this.historyCache.find(i => i.id === id);
            if (item) {
                let text = item.template;
                Object.keys(item.variables).forEach(key => {
                    if (item.variables[key]) {
                        const regex = new RegExp(`\\[${key}\\]`, 'gi');
                        text = text.replace(regex, item.variables[key]);
                    }
                });
                navigator.clipboard.writeText(text);
                this.showToast("Compiled text copied!");
            }
        }

        async clearHistory() {
            if(!confirm("WARNING: This will delete ALL saved history.\n\nContinue?")) return;
            await this.db.clear();
            this.refreshHistory();
            this.showToast("Database flushed");
        }

        // --- Import / Export ---
        async exportData() {
            if (this.historyCache.length === 0) {
                this.showToast("Nothing to export!", true);
                return;
            }
            const blob = new Blob([JSON.stringify(this.historyCache, null, 2)], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `_Backup_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            this.showToast(`Exported ${this.historyCache.length} items`);
        }

        async importData(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const items = JSON.parse(e.target.result);
                    if (Array.isArray(items)) {
                        for (const item of items) {
                            if(item.template && item.id) await this.db.add(item);
                        }
                        this.refreshHistory();
                        this.showToast(`Imported ${items.length} items`);
                    }
                } catch (err) {
                    this.showToast("Invalid JSON file", true);
                }
            };
            reader.readAsText(file);
            input.value = '';
        }

        // --- UI ---
        switchTab(tab) {
            this.currentTab = tab;
            document.getElementById('tab-all').className = tab === 'all'
                ? 'flex-1 py-3 text-sm font-medium text-accent-500 border-b-2 border-accent-500 bg-gray-800/50 transition'
                : 'flex-1 py-3 text-sm font-medium text-gray-500 hover:text-gray-300 border-b-2 border-transparent transition';

            document.getElementById('tab-fav').className = tab === 'fav'
                ? 'flex-1 py-3 text-sm font-medium text-accent-500 border-b-2 border-accent-500 bg-gray-800/50 transition'
                : 'flex-1 py-3 text-sm font-medium text-gray-500 hover:text-gray-300 border-b-2 border-transparent transition';

            this.renderHistoryList();
        }

        filterHistory() {
            this.renderHistoryList();
        }

        showToast(msg, isError = false) {
            const toast = document.getElementById('toast');
            const msgSpan = document.getElementById('toastMsg');
            const icon = toast.querySelector('i');

            msgSpan.textContent = msg;
            icon.className = isError ? 'fa-solid fa-circle-exclamation text-red-500' : 'fa-solid fa-check-circle text-green-400';

            toast.classList.remove('translate-y-20', 'opacity-0');

            if(this.toastTimer) clearTimeout(this.toastTimer);
            this.toastTimer = setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 2500);
        }
    }

    // Init
    window.app = new App();
    window.onload = () => window.app.init();
</script>
</body>
</html>
